<script>
  // ... –í–ï–°–¨ —Ç–≤–æ–π –∫–æ–¥ –≤—ã—à–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...

  let tourIndex = 0;

  function markTourSeen() {
    try { localStorage.setItem(ONBOARDING_KEY, "1"); } catch (e) {}
  }

  function isTourSeen() {
    try { return localStorage.getItem(ONBOARDING_KEY) === "1"; } catch (e) { return false; }
  }

  function renderTourStep() {
    const step = tourSteps[tourIndex] || tourSteps[0];
    tourStepCountEl.textContent = `–®–∞–≥ ${tourIndex + 1} –∏–∑ ${tourSteps.length}`;
    tourTitleEl.textContent = step.title;
    tourBodyEl.textContent = step.body;
    tourNextBtn.textContent = (tourIndex === tourSteps.length - 1) ? "–ì–æ—Ç–æ–≤–æ" : "–î–∞–ª—å—à–µ";
  }

  function openTour() {
    if (!tourModal) return;
    tourIndex = 0;
    renderTourStep();
    tourModal.classList.remove("hidden");
  }

  function closeTour() {
    if (!tourModal) return;
    tourModal.classList.add("hidden");
    markTourSeen();
  }

  function nextTour() {
    if (tourIndex >= tourSteps.length - 1) {
      closeTour();
      return;
    }
    tourIndex++;
    renderTourStep();
  }

  function maybeStartTourAuto() {
    // –∑–∞–ø—É—Å–∫–∞–µ–º —Ç—É—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
    // 1) –ø–æ–ª —É–∂–µ –≤—ã–±—Ä–∞–Ω (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –º–æ–¥–∞–ª–∫–µ –ø–æ–ª–∞)
    // 2) —Ç—É—Ä –µ—â—ë –Ω–µ –±—ã–ª –ø–æ–∫–∞–∑–∞–Ω
    // 3) –º–æ–¥–∞–ª–∫–∞ –ø–æ–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞
    if (userGender && !isTourSeen() && genderModal.classList.contains("hidden")) {
      openTour();
    }
  }

  // --- –†–µ–∂–∏–º—ã (25/5, 50/10, —Å–≤–æ–π —Ä–µ–∂–∏–º) ---
  function setMode(work, brk, custom = false) {
    workMinutes = work;
    breakMinutes = brk;
    isCustomModeActive = !!custom;

    // —Å–±—Ä–æ—Å —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã –≤ —Ñ–æ–∫—É—Å
    pauseTimer();
    isFocus = true;
    remainingSeconds = workMinutes * 60;
    totalSecondsCurrentPhase = remainingSeconds;
    pendingPhase = null;

    // UI
    modeButtons.forEach(b => b.classList.remove("active"));
    if (!custom) {
      document
        .querySelector(`.mode-btn[data-work="${work}"][data-break="${brk}"]`)
        ?.classList.add("active");
      customInputs.style.display = "none";
    } else {
      customModeBtn.classList.add("active");
      customInputs.style.display = "flex";
    }

    resetTipIndexForPhase();
    updateDisplay();
    updateTipText();
  }

  modeButtons.forEach(btn => {
    if (btn.id === "customModeBtn") return;
    btn.addEventListener("click", () => {
      tactileTap();
      const w = parseInt(btn.dataset.work, 10);
      const b = parseInt(btn.dataset.break, 10);
      if (isFinite(w) && isFinite(b)) setMode(w, b, false);
    });
  });

  customModeBtn.addEventListener("click", () => {
    tactileTap();
    // –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–ª—è –≤–≤–æ–¥–∞ + –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫–Ω–æ–ø–∫—É
    modeButtons.forEach(b => b.classList.remove("active"));
    customModeBtn.classList.add("active");
    customInputs.style.display = (customInputs.style.display === "flex") ? "none" : "flex";
  });

  applyCustomBtn.addEventListener("click", () => {
    tactileTap();
    const w = parseInt(customWorkInput.value, 10);
    const b = parseInt(customBreakInput.value, 10);

    if (!isFinite(w) || w < 1 || w > 180) return;
    if (!isFinite(b) || b < 1 || b > 60) return;

    setMode(w, b, true);
  });

  // --- –¢–∞–π–º–µ—Ä ---
  startPauseBtn.addEventListener("click", () => {
    tactileTap();
    if (phaseModal && !phaseModal.classList.contains("hidden")) return; // –ø–æ–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ —Ñ–∞–∑—ã ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
    if (isRunning) pauseTimer();
    else startTimer();
  });

  resetBtn.addEventListener("click", () => {
    tactileTap();
    resetTimer();
  });

  // --- –ú–æ–¥–∞–ª–∫–∞ —Å–º–µ–Ω—ã —Ñ–∞–∑—ã ---
  phaseModalBtn.addEventListener("click", () => {
    tactileTap();
    confirmPhaseChange();
  });

  // --- –°–æ–≤–µ—Ç—ã ---
  nextTipBtn.addEventListener("click", () => {
    tactileTap();
    nextTip();
  });

  // --- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: –º–æ–¥–∞–ª–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è ---
  achBadges.forEach(badge => {
    badge.addEventListener("click", () => {
      tactileTap();
      const title = badge.getAttribute("data-title") || "–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ";
      const desc = badge.getAttribute("data-desc") || "";
      const threshold = parseInt(badge.getAttribute("data-threshold") || "0", 10);
      const earned = cycles >= threshold;

      const svgHTML = badge.querySelector(".ach-icon")?.innerHTML
        ? `<svg viewBox="0 0 24 24">${badge.querySelector(".ach-icon")?.innerHTML}</svg>`
        : "";

      openInfoModal({
        svgHTML,
        title,
        statusText: earned ? "–û—Ç–∫—Ä—ã—Ç–æ —Å–µ–≥–æ–¥–Ω—è" : `–ù—É–∂–Ω–æ: ${threshold} ${pluralRu(threshold, ["—Ü–∏–∫–ª", "—Ü–∏–∫–ª–∞", "—Ü–∏–∫–ª–æ–≤"])}`,
        statusEarned: earned,
        body: desc
      });
    });
  });

  // --- –§–∏—à–∫–∞ METTA ---
  featurePill.addEventListener("click", () => {
    tactileTap();
    openInfoModal({
      svgHTML: `<svg viewBox="0 0 24 24"><path d="M12 3c2.2 0 4 1.8 4 4 0 1.3-.6 2.4-1.5 3.1C13.4 11 13 12 13 13c0 1.7 1.3 3 3 3" /><path d="M12 21c-2.2 0-4-1.8-4-4 0-1.3.6-2.4 1.5-3.1C10.6 13 11 12 11 11c0-1.7-1.3-3-3-3"/></svg>`,
      title: "–§–∏—à–∫–∞ METTA",
      statusText: "–ì–∏–±–∫–∏–π ¬´–ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫¬ª",
      statusEarned: true,
      body: "–ú–µ—Ö–∞–Ω–∏–∑–º ¬´–≥–∏–±–∫–æ–≥–æ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞¬ª –≤ —Å–ø–∏–Ω–∫–µ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–∑–≥–∏–±—ã —Å–ø–∏–Ω—ã –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã."
    });
  });

  // --- –°–µ—Ä–∏—è –¥–Ω–µ–π ---
  streakMain.addEventListener("click", () => {
    tactileTap();
    const svgHTML = `<span style="font-size:22px;">üî•</span>`;
    openInfoModal({
      svgHTML,
      title: "–°–µ—Ä–∏—è –¥–Ω–µ–π",
      statusText: `${currentStreak} ${pluralRu(currentStreak, ["–¥–µ–Ω—å", "–¥–Ω—è", "–¥–Ω–µ–π"])} –ø–æ–¥—Ä—è–¥`,
      statusEarned: true,
      body: getStreakPraise(currentStreak)
    });
  });

  // --- Info modal close ---
  infoCloseBtn.addEventListener("click", () => {
    tactileTap();
    closeInfoModal();
  });

  // --- –í—ã–±–æ—Ä –ø–æ–ª–∞ ---
  genderMaleBtn.addEventListener("click", () => {
    tactileTap();
    setGender("male");
  });

  genderFemaleBtn.addEventListener("click", () => {
    tactileTap();
    setGender("female");
  });

  // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
  settingsBtn.addEventListener("click", () => {
    tactileTap();
    openSettingsModal();
  });

  settingsCloseBtn.addEventListener("click", () => {
    tactileTap();
    closeSettingsModal();
  });

  themeDarkBtn.addEventListener("click", () => {
    tactileTap();
    applyTheme("dark", true);
  });

  themeLightBtn.addEventListener("click", () => {
    tactileTap();
    applyTheme("light", true);
  });

  settingsGenderMale.addEventListener("click", () => {
    tactileTap();
    setGender("male");
  });

  settingsGenderFemale.addEventListener("click", () => {
    tactileTap();
    setGender("female");
  });

  settingsTourBtn.addEventListener("click", () => {
    tactileTap();
    closeSettingsModal();
    openTour();
  });

  // --- –¢—É—Ä ---
  tourSkipBtn.addEventListener("click", () => {
    tactileTap();
    closeTour();
  });

  tourNextBtn.addEventListener("click", () => {
    tactileTap();
    nextTour();
  });

  // --- –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω (–∞–∫–∫—É—Ä–∞—Ç–Ω–æ) ---
  function closeOnBackdrop(e, modalEl, closeFn) {
    if (e.target === modalEl) closeFn();
  }

  infoModal.addEventListener("click", (e) => closeOnBackdrop(e, infoModal, closeInfoModal));
  settingsModal.addEventListener("click", (e) => closeOnBackdrop(e, settingsModal, closeSettingsModal));
  tourModal.addEventListener("click", (e) => closeOnBackdrop(e, tourModal, closeTour));
  // phaseModal –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º ‚Äî —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–æ–π (–∏–Ω–∞—á–µ –ª—é–¥–∏ –±—É–¥—É—Ç —Å–ª—É—á–∞–π–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å)

  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---
  loadGenderFromStorage();
  loadThemeFromStorage();
  initCyclesToday();
  initStreak();

  updateWaterGradientForTheme();
  resetTipIndexForPhase();
  updateDisplay();
  updateTipText();

  showGenderModalIfNeeded();
  maybeStartTourAuto();
</script>
