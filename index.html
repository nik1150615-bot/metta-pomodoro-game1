<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>METTA Pomodoro Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0b1220 0, #020617 45%, #020617 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      transition: background 0.25s ease-out, color 0.25s ease-out;
    }

    .shell {
      width: 100%;
      max-width: 480px;
      padding: 12px 10px;
    }

    .card {
      width: 100%;
      height: calc(100vh - 24px);
      max-height: 780px;
      background: #020617;
      border-radius: 20px;
      padding: 18px 18px 14px;
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(30, 64, 175, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      transition: background 0.25s ease-out, box-shadow 0.25s ease-out, border-color 0.25s ease-out;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.25);
      color: #c7d2fe;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 600;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
    }

    h1 {
      font-size: 20px;
      text-align: left;
      margin: 0;
      color: #e5e7eb;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      text-align: left;
      margin-bottom: 4px;
      max-width: 260px;
    }

    /* –§–ò–®–ö–ê METTA */

    .feature {
      margin-bottom: 6px;
    }

    .feature-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 12px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0, rgba(59,130,246,0.5), transparent 55%);
      border: 1px solid rgba(59, 130, 246, 0.5);
      box-shadow:
        0 0 18px rgba(59, 130, 246, 0.4),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      font-size: 11px;
      color: #e5e7eb;
      cursor: pointer;
    }

    .feature-pill:hover {
      box-shadow:
        0 0 24px rgba(59, 130, 246, 0.6),
        0 0 0 1px rgba(129, 140, 248, 0.8);
    }

    .feature-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #111827 0, #020617 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(59,130,246,0.7);
    }

    .feature-spine {
      width: 10px;
      height: 14px;
      position: relative;
      transform-origin: center;
      animation: spine-wave 1.6s ease-in-out infinite;
    }

    .feature-spine span {
      position: absolute;
      left: 2px;
      right: 2px;
      height: 3px;
      border-radius: 999px;
      background: #60a5fa;
      box-shadow: 0 0 6px rgba(96,165,250,0.9);
    }

    .feature-spine span:nth-child(1) { top: 0; }
    .feature-spine span:nth-child(2) { top: 5px; }
    .feature-spine span:nth-child(3) { top: 10px; }

    @keyframes spine-wave {
      0%, 100% { transform: translateY(0) rotate(-4deg); }
      50%      { transform: translateY(-1px) rotate(3deg); }
    }

    .feature-text-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .feature-title {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
      color: #bfdbfe;
    }

    .feature-text {
      color: #9ca3af;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 90px;
      justify-content: flex-end;
    }

    .logo-mark {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #111827 0, #020617 70%);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      box-shadow:
        0 4px 12px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(148, 163, 184, 0.45);
    }

    .logo-text { text-align: left; }

    .logo-brand {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #f9fafb;
      line-height: 1.1;
    }

    .logo-sub {
      font-size: 9px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    .settings-btn {
      margin-left: 6px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      background: #020617;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.9);
      padding: 0;
    }

    .settings-btn:hover {
      box-shadow:
        0 0 0 1px rgba(148,163,184,0.9),
        0 0 14px rgba(59,130,246,0.6);
    }

    .modes {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .mode-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.8);
    }

    .mode-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.7);
      display: inline-block;
    }

    .mode-btn.active {
      background: #22c55e;
      color: #020617;
      border-color: #22c55e;
      box-shadow:
        0 0 0 1px rgba(34, 197, 94, 0.85),
        0 0 18px rgba(34, 197, 94, 0.55);
    }

    .custom-inputs {
      margin-top: 4px;
      display: none;
      gap: 6px;
      justify-content: flex-start;
      flex-wrap: wrap;
      margin-bottom: 2px;
    }

    .custom-inputs input {
      width: 92px;
      padding: 5px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      outline: none;
      background: #020617;
      color: #e5e7eb;
    }

    .custom-inputs input::placeholder { color: #6b7280; }
    .custom-inputs input:focus { border-color: #22c55e; }

    .custom-inputs button {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      cursor: pointer;
      color: #e5e7eb;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0 4px;
    }

    .status {
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-pill {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    .status.focus .status-pill { background: #22c55e; }
    .status.break .status-pill { background: #38bdf8; }

    .status-label { font-weight: 600; }
    .status.focus .status-label { color: #4ade80; }
    .status.break .status-label { color: #38bdf8; }

    .cycles {
      font-size: 12px;
      color: #9ca3af;
      text-align: right;
    }

    .timer-wrap {
      margin: 4px 0 4px;
      display: flex;
      justify-content: center;
      flex-shrink: 0;
    }

    .timer-circle {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 0, #1f2937 0, #020617 55%, #020617 100%);
      box-shadow:
        inset 0 0 0 1px rgba(55, 65, 81, 0.8),
        0 10px 40px rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: visible;
      transition: background 0.25s ease-out, box-shadow 0.25s ease-out;
    }

    .timer-svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      pointer-events: none;
    }

    .timer,
    .phase-label {
      position: relative;
      z-index: 2;
      transition:
        color 0.25s ease-out,
        text-shadow 0.25s ease-out;
    }

    .timer-circle.over-water .timer,
    .timer-circle.over-water .phase-label {
      color: #020617;
      text-shadow: 0 0 8px rgba(190, 242, 100, 0.8);
    }

    .timer {
      font-size: 42px;
      font-weight: 700;
      color: #f9fafb;
    }

    .phase-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-top: 5px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 6px;
      margin-top: 2px;
      flex-shrink: 0;
    }

    button.main-btn {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #22c55e;
      color: #020617;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow:
        0 0 0 1px rgba(34, 197, 94, 0.85),
        0 8px 24px rgba(34, 197, 94, 0.45);
    }

    button.secondary-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      font-size: 13px;
      background: #020617;
      cursor: pointer;
      color: #e5e7eb;
    }

    .achievements {
      margin-top: 4px;
      margin-bottom: 4px;
      text-align: left;
      flex-shrink: 0;
    }

    .ach-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.13em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .ach-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .ach-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px dashed #4b5563;
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #020617;
      cursor: pointer;
    }

    .ach-badge:hover {
      border-style: solid;
      border-color: #4b5563;
    }

    .ach-icon {
      width: 14px;
      height: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .ach-icon svg {
      width: 14px;
      height: 14px;
      stroke: #6b7280;
      fill: none;
    }

    .ach-badge.earned {
      border-style: solid;
      border-color: #22c55e;
      background: #022c22;
      color: #e5e7eb;
      box-shadow: 0 0 14px rgba(34, 197, 94, 0.3);
    }

    .ach-badge.earned svg { stroke: #bbf7d0; }

    .streak {
      margin-top: 2px;
      margin-bottom: 4px;
      text-align: left;
      flex-shrink: 0;
    }

    .streak-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.13em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .streak-main {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .streak-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #1f2937 0, #020617 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 0 1px #1f2937,
        0 0 18px rgba(0,0,0,0.8);
      transition: transform 0.25s ease-out,
                  box-shadow 0.25s ease-out,
                  background 0.25s ease-out;
    }

    /* –û–ì–û–ù–Å–ö üî• + –¥—ã—Ö–∞–Ω–∏–µ */
    #streakFire {
      font-size: 22px;
      transition:
        font-size 0.25s ease-out,
        filter 0.25s ease-out;
      filter: drop-shadow(0 0 4px rgba(249,115,22,0.6));
      animation: fire-breath 1.8s ease-in-out infinite;
      transform-origin: center;
      display: inline-block;
    }

    @keyframes fire-breath {
      0%, 100% { transform: translateY(0) scale(1); }
      50%      { transform: translateY(-1px) scale(1.06); }
    }

    .streak-icon.low  #streakFire {
      filter: drop-shadow(0 0 4px rgba(249,115,22,0.7));
    }

    .streak-icon.mid  #streakFire {
      filter: drop-shadow(0 0 8px rgba(249,115,22,0.9));
    }

    .streak-icon.high #streakFire {
      filter: drop-shadow(0 0 12px rgba(234,179,8,1));
    }

    .streak-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .streak-value { font-size: 13px; color: #e5e7eb; }
    .streak-status { font-size: 11px; color: #9ca3af; }

    .tips-row {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .tips-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .tips-text {
      font-size: 14px;
      color: #e5e7eb;
      text-align: left;
      line-height: 1.45;
      flex: 1;
    }

    .tips-text strong {
      color: #a5b4fc;
      font-weight: 600;
    }

    .tip-nav {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .tip-button {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    .tip-hint {
      font-size: 9px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    .spacer { flex: 1; }

    /* –ú–æ–¥–∞–ª–∫–∞ —Å–º–µ–Ω—ã —Ñ–∞–∑—ã */

    .phase-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .phase-modal.hidden { display: none; }

    .phase-modal-inner {
      width: 100%;
      max-width: 360px;
      background: #020617;
      border-radius: 22px;
      padding: 22px 18px 16px;
      box-shadow:
        0 28px 70px rgba(0,0,0,0.95),
        0 0 0 1px rgba(59, 130, 246, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.5);
      text-align: left;
    }

    .phase-modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #f9fafb;
    }

    .phase-modal-text {
      font-size: 14px;
      color: #d1d5db;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .phase-modal-note {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 14px;
    }

    .phase-modal-btn {
      width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #22c55e;
      color: #020617;
      box-shadow:
        0 0 0 1px rgba(34, 197, 94, 0.8),
        0 10px 26px rgba(34, 197, 94, 0.5);
    }

    /* –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Ñ—ã (–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è / —Ñ–∏—à–∫–∞ / —Å–µ—Ä–∏—è –¥–Ω–µ–π) */

    .info-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 25;
    }

    .info-modal.hidden { display: none; }

    .info-modal-inner {
      width: 100%;
      max-width: 360px;
      background: #020617;
      border-radius: 22px;
      padding: 20px 18px 14px;
      box-shadow:
        0 28px 70px rgba(0,0,0,0.95),
        0 0 0 1px rgba(59, 130, 246, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.5);
      text-align: left;
    }

    .info-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .info-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0, #1f2937 0, #020617 80%);
      box-shadow:
        0 0 0 1px #1f2937,
        0 0 18px rgba(0,0,0,0.8);
    }

    .info-icon svg {
      width: 26px;
      height: 26px;
      stroke-width: 1.6;
      fill: none;
      stroke: #e5e7eb;
    }

    .info-icon.earned {
      background: radial-gradient(circle at 30% 0, #22c55e 0, #16a34a 60%);
      box-shadow:
        0 0 24px rgba(34,197,94,0.8),
        0 0 0 1px rgba(21,128,61,0.9);
      animation: info-pulse 1.4s ease-in-out infinite;
    }

    .info-icon.earned svg {
      stroke: #022c22;
    }

    .info-icon.locked {
      opacity: 0.55;
      filter: grayscale(1);
    }

    @keyframes info-pulse {
      0%, 100% { transform: scale(1); }
      50%      { transform: scale(1.06); }
    }

    .info-title {
      font-size: 16px;
      font-weight: 600;
      color: #f9fafb;
      margin-bottom: 2px;
    }

    .info-status {
      font-size: 12px;
      color: #9ca3af;
    }

    .info-status-earned {
      color: #bbf7d0;
    }

    .info-body {
      font-size: 14px;
      color: #d1d5db;
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .info-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    .info-close {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      background: #111827;
      color: #e5e7eb;
      box-shadow: 0 0 0 1px #4b5563;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª–∞ */

    .gender-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .gender-modal.hidden { display: none; }

    .gender-inner {
      width: 100%;
      max-width: 360px;
      background: #020617;
      border-radius: 22px;
      padding: 22px 18px 18px;
      box-shadow:
        0 28px 70px rgba(0,0,0,0.95),
        0 0 0 1px rgba(59, 130, 246, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.5);
      text-align: left;
    }

    .gender-title {
      font-size: 17px;
      font-weight: 600;
      color: #f9fafb;
      margin-bottom: 6px;
    }

    .gender-sub {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 14px;
    }

    .gender-options {
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }

    .gender-btn {
      flex: 1;
      border-radius: 18px;
      padding: 10px 8px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at 30% 0, #111827 0, #020617 70%);
      color: #e5e7eb;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      box-shadow: 0 0 0 1px #0f172a;
    }

    .gender-btn:hover {
      box-shadow:
        0 0 0 1px #22c55e,
        0 0 18px rgba(34,197,94,0.4);
    }

    .gender-emoji {
      font-size: 30px;
      animation: gender-bounce 1.4s ease-in-out infinite;
    }

    .gender-label {
      font-size: 13px;
      font-weight: 500;
    }

    @keyframes gender-bounce {
      0%, 100% { transform: translateY(0); }
      50%      { transform: translateY(-3px) scale(1.05); }
    }

    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */

    .settings-inner .info-title {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .settings-section {
      margin-bottom: 12px;
    }

    .settings-section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .settings-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .settings-pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
    }

    .settings-pill-active {
      border-color: #22c55e;
      background: #022c22;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.7);
    }

    .settings-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .settings-help-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
    }

    /* –û–Ω–±–æ—Ä–¥–∏–Ω–≥ (—Ç—É—Ä) */

    .tour-inner .info-title {
      font-size: 17px;
      margin-bottom: 6px;
    }

    .tour-step-count {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .tour-buttons {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .tour-skip {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
    }

    .tour-next {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #020617;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow:
        0 0 0 1px rgba(34,197,94,0.8),
        0 8px 22px rgba(34,197,94,0.45);
    }

    @media (max-width: 420px) {
      .card {
        border-radius: 16px;
        padding: 14px 12px 10px;
      }
      .timer-circle {
        width: 180px;
        height: 180px;
      }
      .timer { font-size: 36px; }
      .subtitle { max-width: 220px; }
      .logo-brand { font-size: 12px; }
      .logo-sub { font-size: 8px; }
      .phase-modal-inner,
      .info-modal-inner,
      .gender-inner {
        max-width: 320px;
        padding: 18px 14px 12px;
      }
    }

    /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è */

    @media (orientation: landscape) {
      .shell {
        max-width: 900px;
        padding: 8px 10px;
      }
      .card {
        height: auto;
        max-height: none;
        padding: 12px 18px 10px;
      }
      .header { margin-bottom: 4px; }
      h1 { font-size: 18px; }
      .subtitle { font-size: 12px; max-width: 280px; }

      .feature { margin-bottom: 4px; }
      .feature-pill { font-size: 10px; padding: 4px 9px; }

      .modes { margin-bottom: 4px; }

      .timer-circle {
        width: 160px;
        height: 160px;
      }
      .timer { font-size: 32px; }
      .phase-label { font-size: 11px; }

      .ach-label,
      .streak-label {
        font-size: 10px;
      }

      .tips-text {
        font-size: 13px;
      }
    }

    @media (orientation: landscape) and (max-height: 480px) {
      .card {
        transform: scale(0.9);
        transform-origin: top center;
      }
    }

    /* –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê */

    body.light-theme {
      background: radial-gradient(circle at top, #e5e7eb 0, #f3f4f6 45%, #e5e7eb 100%);
      color: #020617;
    }

    body.light-theme .card {
      background: #f9fafb;
      box-shadow:
        0 18px 40px rgba(148,163,184,0.65),
        0 0 0 1px rgba(148, 163, 184, 0.6);
      border-color: rgba(148, 163, 184, 0.6);
    }

    body.light-theme h1 {
      color: #020617;
    }

    body.light-theme .subtitle {
      color: #4b5563;
    }

    body.light-theme .badge {
      background: rgba(59,130,246,0.08);
      color: #1d4ed8;
    }

    body.light-theme .feature-pill {
      background: radial-gradient(circle at 0 0, rgba(59,130,246,0.15), transparent 55%);
      box-shadow:
        0 0 10px rgba(191,219,254,0.7),
        0 0 0 1px rgba(191,219,254,0.9);
    }

    body.light-theme .feature-text {
      color: #4b5563;
    }

    body.light-theme .logo-mark {
      background: radial-gradient(circle at 30% 20%, #e5e7eb 0, #cbd5f5 70%);
      color: #020617;
      box-shadow:
        0 4px 10px rgba(148,163,184,0.8),
        0 0 0 1px rgba(148,163,184,0.9);
    }

    body.light-theme .logo-brand {
      color: #020617;
    }

    body.light-theme .logo-sub {
      color: #6b7280;
    }

    body.light-theme .settings-btn {
      background: #f9fafb;
      color: #111827;
      border-color: rgba(148,163,184,0.9);
      box-shadow: 0 0 0 1px rgba(209,213,219,0.9);
    }

    body.light-theme .settings-btn:hover {
      box-shadow:
        0 0 0 1px rgba(59,130,246,0.9),
        0 0 10px rgba(59,130,246,0.4);
    }

    body.light-theme .mode-btn {
      background: #f9fafb;
      color: #111827;
      border-color: rgba(209,213,219,0.9);
      box-shadow: 0 0 0 1px rgba(209,213,219,0.9);
    }

    body.light-theme .mode-btn.active {
      background: #3b82f6;
      color: #eff6ff;
      border-color: #2563eb;
      box-shadow:
        0 0 0 1px rgba(59,130,246,0.9),
        0 0 18px rgba(59,130,246,0.6);
    }

    body.light-theme .custom-inputs input,
    body.light-theme .custom-inputs button {
      background: #f9fafb;
      color: #111827;
      border-color: #d1d5db;
    }

    body.light-theme .status-label {
      color: #047857;
    }

    body.light-theme .cycles {
      color: #4b5563;
    }

    /* –≥–æ–ª—É–±–æ–π —Ç–∞–π–º–µ—Ä-–∫—Ä—É–≥ –≤ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ */
    body.light-theme .timer-circle {
      background: radial-gradient(circle at 30% 0, #dbeafe 0, #bfdbfe 45%, #93c5fd 100%);
      box-shadow:
        inset 0 0 0 1px rgba(147,197,253,0.9),
        0 10px 26px rgba(147,197,253,0.8);
    }

    body.light-theme .timer {
      color: #020617;
    }

    body.light-theme .phase-label {
      color: #4b5563;
    }

    /* –≥–æ–ª—É–±–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ */

    body.light-theme button.main-btn {
      background: #3b82f6;
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(37,99,235,0.9),
        0 8px 24px rgba(59,130,246,0.55);
    }

    body.light-theme button.secondary-btn {
      background: #eff6ff;
      color: #1f2937;
      border-color: #bfdbfe;
    }

    body.light-theme .ach-label,
    body.light-theme .streak-label {
      color: #9ca3af;
    }

    body.light-theme .ach-badge {
      background: #f9fafb;
      color: #4b5563;
      border-color: #d1d5db;
    }

    body.light-theme .ach-badge.earned {
      background: #dcfce7;
      color: #065f46;
      border-color: #16a34a;
      box-shadow: 0 0 10px rgba(74,222,128,0.6);
    }

    body.light-theme .streak-icon {
      background: radial-gradient(circle at 30% 0, #f97316 0, #facc15 60%);
      box-shadow:
        0 0 0 1px #fb923c,
        0 0 18px rgba(251,191,36,0.9);
    }

    body.light-theme .streak-value {
      color: #111827;
    }

    body.light-theme .streak-status {
      color: #4b5563;
    }

    body.light-theme .tips-row {
      border-top-color: #e5e7eb;
    }

    body.light-theme .tips-text {
      color: #111827;
    }

    body.light-theme .tips-text strong {
      color: #4338ca;
    }

    body.light-theme .tip-button {
      background: #f9fafb;
      color: #111827;
      border-color: #d1d5db;
    }

    body.light-theme .phase-modal-inner,
    body.light-theme .info-modal-inner,
    body.light-theme .gender-inner {
      background: #f9fafb;
      border-color: #e5e7eb;
      box-shadow:
        0 18px 40px rgba(148,163,184,0.9),
        0 0 0 1px rgba(191,219,254,0.9);
    }

    body.light-theme .phase-modal-title,
    body.light-theme .info-title,
    body.light-theme .gender-title {
      color: #020617;
    }

    body.light-theme .phase-modal-text,
    body.light-theme .info-body,
    body.light-theme .gender-sub {
      color: #4b5563;
    }

    body.light-theme .info-close,
    body.light-theme .tour-skip,
    body.light-theme .settings-help-btn {
      background: #f9fafb;
      color: #111827;
      box-shadow: 0 0 0 1px #d1d5db;
    }

    body.light-theme .settings-pill {
      background: #f9fafb;
      color: #111827;
      border-color: #d1d5db;
    }

    body.light-theme .settings-pill-active {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #2563eb;
    }

    body.light-theme .gender-btn {
      background: radial-gradient(circle at 30% 0, #e5e7eb 0, #d1d5db 70%);
      color: #111827;
      border-color: #cbd5e1;
      box-shadow: 0 0 0 1px #e5e7eb;
    }

    body.light-theme .info-icon {
      background: radial-gradient(circle at 30% 0, #e5e7eb 0, #d1d5db 80%);
      box-shadow: 0 0 0 1px #d1d5db;
    }

    body.light-theme .info-icon svg {
      stroke: #111827;
    }

    body.light-theme .phase-modal {
      background: rgba(15,23,42,0.3);
    }

    body.light-theme .info-modal,
    body.light-theme .gender-modal {
      background: rgba(148,163,184,0.35);
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="header">
        <div>
          <div class="badge">
            <span class="badge-dot"></span>
            METTA ‚Ä¢ Focus
          </div>
          <h1>Pomodoro –¥–ª—è —Å–ø–∏–Ω—ã</h1>
          <div class="subtitle">
            –†–∞–±–æ—Ç–∞–π –ø–æ —Ç–∞–π–º–µ—Ä—É, –¥–µ–ª–∞–π –ø–∞—É–∑—ã –∏ –Ω–µ –¥–∞–≤–∞–π —Å–ø–∏–Ω–µ —Å–¥–∞–≤–∞—Ç—å—Å—è.
          </div>
          <div id="featurePill" class="feature">
            <div class="feature-pill">
              <div class="feature-icon">
                <div class="feature-spine">
                  <span></span><span></span><span></span>
                </div>
              </div>
              <div class="feature-text-wrap">
                <div class="feature-title">–§–∏—à–∫–∞ METTA</div>
                <div class="feature-text">–ì–∏–±–∫–∏–π ¬´–ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫¬ª —Å–ø–∏–Ω–∫–∏ ‚Äî –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ø–æ—è—Å–Ω–∏—Ü—É.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="logo">
          <div class="logo-mark">M</div>
          <div class="logo-text">
            <div class="logo-brand">METTA</div>
            <div class="logo-sub">ERGONOMIC CHAIRS</div>
          </div>
          <button id="settingsBtn" class="settings-btn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
        </div>
      </div>

      <div class="modes">
        <button class="mode-btn active" data-work="25" data-break="5">
          <span class="mode-dot"></span><span>25 / 5</span>
        </button>
        <button class="mode-btn" data-work="50" data-break="10">
          <span class="mode-dot"></span><span>50 / 10</span>
        </button>
        <button class="mode-btn" id="customModeBtn">
          <span class="mode-dot"></span><span>–°–≤–æ–π —Ä–µ–∂–∏–º</span>
        </button>
      </div>

      <div class="custom-inputs" id="customInputs">
        <input type="number" id="customWork" placeholder="–†–∞–±–æ—Ç–∞, –º–∏–Ω" min="1" max="180">
        <input type="number" id="customBreak" placeholder="–ü–µ—Ä–µ—Ä—ã–≤, –º–∏–Ω" min="1" max="60">
        <button class="secondary-btn" id="applyCustom">OK</button>
      </div>

      <div class="status-row">
        <div id="status" class="status focus">
          <span class="status-pill"></span>
          <span class="status-label">–†–µ–∂–∏–º —Ñ–æ–∫—É—Å–∞</span>
        </div>
        <div id="cycles" class="cycles">–ó–∞–≤–µ—Ä—à–µ–Ω–æ —Ü–∏–∫–ª–æ–≤: 0</div>
      </div>

      <div class="timer-wrap">
        <div class="timer-circle">
          <svg class="timer-svg" viewBox="0 0 200 200" aria-hidden="true">
            <defs>
              <!-- –¥–≤–µ –∑–∞–ª–∏–≤–∫–∏: —Ç—ë–º–Ω–∞—è (–∑–µ–ª—ë–Ω–∞—è) –∏ —Å–≤–µ—Ç–ª–∞—è (–≥–æ–ª—É–±–∞—è) -->
              <linearGradient id="waterGradientDark" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#22c55e"/>
                <stop offset="100%" stop-color="#16a34a"/>
              </linearGradient>
              <linearGradient id="waterGradientLight" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#bfdbfe"/>
                <stop offset="100%" stop-color="#60a5fa"/>
              </linearGradient>
              <clipPath id="waterClip">
                <circle cx="100" cy="100" r="100"></circle>
              </clipPath>
            </defs>
            <g clip-path="url(#waterClip)">
              <rect id="waterRect" x="0" y="200" width="200" height="0" fill="url(#waterGradientDark)"></rect>
            </g>
          </svg>
          <div id="timer" class="timer">25:00</div>
          <div id="phaseLabel" class="phase-label">–§–æ–∫—É—Å-—Å–µ—Å—Å–∏—è</div>
        </div>
      </div>

      <div class="controls">
        <button id="startPauseBtn" class="main-btn">
          <span>‚ñ∂</span><span>–°—Ç–∞—Ä—Ç</span>
        </button>
        <button id="resetBtn" class="secondary-btn">–°–±—Ä–æ—Å</button>
      </div>

      <div class="achievements">
        <div class="ach-label">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è</div>
        <div class="ach-badges">
          <div class="ach-badge" data-threshold="1"
               data-title="–ù–æ–≤–∏—á–æ–∫ —Ñ–æ–∫—É—Å–∞"
               data-desc="–¢—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª(–∞) –ø–µ—Ä–≤—ã–π —Ñ–æ–∫—É—Å-—Ü–∏–∫–ª –∑–∞ —Å–µ–≥–æ–¥–Ω—è. –û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ –ø—Ä–∏–≤—ã—á–∫–∏.">
            <div class="ach-icon">
              <svg viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="7.5"/>
                <circle cx="12" cy="12" r="4"/>
                <circle cx="12" cy="12" r="1.2"/>
              </svg>
            </div>
            <span>–ù–æ–≤–∏—á–æ–∫ —Ñ–æ–∫—É—Å–∞</span>
          </div>
          <div class="ach-badge" data-threshold="3"
               data-title="–î—Ä—É–≥ —Å–ø–∏–Ω—ã"
               data-desc="3 —Ñ–æ–∫—É—Å-—Ü–∏–∫–ª–∞ –∑–∞ –¥–µ–Ω—å ‚Äî —ç—Ç–æ —É–∂–µ –∑–∞–±–æ—Ç–∞ –æ —Å–ø–∏–Ω–µ, –∞ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å.">
            <div class="ach-icon">
              <svg viewBox="0 0 24 24">
                <path d="M12 3.5L6.5 5.5V11.5C6.5 14.8 8.7 17.7 12 18.8C15.3 17.7 17.5 14.8 17.5 11.5V5.5L12 3.5Z"/>
              </svg>
            </div>
            <span>–î—Ä—É–≥ —Å–ø–∏–Ω—ã</span>
          </div>
          <div class="ach-badge" data-threshold="5"
               data-title="–ì–µ—Ä–æ–π –¥–µ–¥–ª–∞–π–Ω–∞"
               data-desc="5 —Ñ–æ–∫—É—Å-—Ü–∏–∫–ª–æ–≤ ‚Äî —Ç—ã —É–º–µ–µ—à—å —Ä–∞–±–æ—Ç–∞—Ç—å –≥–ª—É–±–æ–∫–æ –∏ –Ω–µ –∑–∞–±—ã–≤–∞—Ç—å –æ –ø–∞—É–∑–∞—Ö.">
            <div class="ach-icon">
              <svg viewBox="0 0 24 24">
                <path d="M12 3L8 13H12L11 21L16 11H12L12 3Z"/>
              </svg>
            </div>
            <span>–ì–µ—Ä–æ–π –¥–µ–¥–ª–∞–π–Ω–∞</span>
          </div>
          <div class="ach-badge" data-threshold="8"
               data-title="–õ–µ–≥–µ–Ω–¥–∞ METTA"
               data-desc="8 –∏ –±–æ–ª–µ–µ —Ü–∏–∫–ª–æ–≤ –∑–∞ –¥–µ–Ω—å ‚Äî —É—Ä–æ–≤–µ–Ω—å –ª–µ–≥–µ–Ω–¥—ã. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –∑–∞–±—ã–≤–∞–π –æ—Ç–¥—ã—Ö–∞—Ç—å.">
            <div class="ach-icon">
              <svg viewBox="0 0 24 24">
                <path d="M9 4H15V8C15 9.7 13.7 11 12 11C10.3 11 9 9.7 9 8V4Z"/>
                <path d="M9 4H6.5C6.2 4 6 4.2 6 4.5C6 7 7.5 9 9.5 9"/>
                <path d="M15 4H17.5C17.8 4 18 4.2 18 4.5C18 7 16.5 9 14.5 9"/>
                <path d="M10 14H14"/>
                <path d="M11 14V16.5L10 18V19H14V18L13 16.5V14"/>
              </svg>
            </div>
            <span>–õ–µ–≥–µ–Ω–¥–∞ METTA</span>
          </div>
        </div>
      </div>

      <div class="streak">
        <div class="streak-label">–°–µ—Ä–∏—è –¥–Ω–µ–π</div>
        <div class="streak-main" id="streakMain">
          <div class="streak-icon" id="streakIcon">
            <span id="streakFire">üî•</span>
          </div>
          <div class="streak-text">
            <div id="streakValue" class="streak-value">0 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
            <div id="streakStatus" class="streak-status">–ù–∞—á–Ω–∏ —Å–µ—Ä–∏—é —Å–µ–≥–æ–¥–Ω—è</div>
          </div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="tips-row" id="tipRow">
        <div class="tips-icon">üí∫</div>
        <div class="tips-text">
          <strong>–°–æ–≤–µ—Ç:</strong> –Ω–∞—Å—Ç—Ä–æ–π –∫—Ä–µ—Å–ª–æ —Ç–∞–∫, —á—Ç–æ–±—ã –∫–æ–ª–µ–Ω–∏ –±—ã–ª–∏ –ø–æ–¥ —É–≥–ª–æ–º ~90¬∞, –∞ —Å–ø–∏–Ω–∞ –ø–ª–æ—Ç–Ω–æ –ø—Ä–∏–ª–µ–≥–∞–ª–∞ –∫ —Å–ø–∏–Ω–∫–µ.
        </div>
        <div class="tip-nav">
          <button class="tip-button" id="nextTipBtn">‚Ä∫</button>
          <div class="tip-hint">–°–º–µ–Ω–∏—Ç—å</div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–º–µ–Ω—ã —Ñ–∞–∑—ã -->
  <div id="phaseModal" class="phase-modal hidden">
    <div class="phase-modal-inner">
      <div id="phaseModalTitle" class="phase-modal-title">–§–æ–∫—É—Å-—Å–µ—Å—Å–∏—è –æ–∫–æ–Ω—á–µ–Ω–∞</div>
      <div id="phaseModalText" class="phase-modal-text">
        –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äî —ç—Ç–æ –µ—â—ë –æ–¥–∏–Ω —à–∞–≥ –∫ —Å–ø–æ–∫–æ–π–Ω–æ–π —Å–ø–∏–Ω–µ –∏ –≥–æ–ª–æ–≤–µ.
      </div>
      <div id="phaseModalNote" class="phase-modal-note">
        –ù–∞–∂–º–∏, –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—à—å –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∞–∑–µ.
      </div>
      <button id="phaseModalBtn" class="phase-modal-btn">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∞–∑–µ</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π / —Ñ–∏—à–∫–∏ METTA / —Å–µ—Ä–∏–∏ –¥–Ω–µ–π -->
  <div id="infoModal" class="info-modal hidden">
    <div class="info-modal-inner">
      <div class="info-header">
        <div id="infoIcon" class="info-icon"></div>
        <div>
          <div id="infoTitle" class="info-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</div>
          <div id="infoStatus" class="info-status">–°—Ç–∞—Ç—É—Å</div>
        </div>
      </div>
      <div id="infoBody" class="info-body">–û–ø–∏—Å–∞–Ω–∏–µ.</div>
      <div class="info-footer">
        <button id="infoCloseBtn" class="info-close">–ü–æ–Ω—è—Ç–Ω–æ</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª–∞ -->
  <div id="genderModal" class="gender-modal hidden">
    <div class="gender-inner">
      <div class="gender-title">–ö–∞–∫ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?</div>
      <div class="gender-sub">
        –í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç, —á—Ç–æ–±—ã –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤—É—á–∞–ª–∏ –±–æ–ª–µ–µ –ª–∏—á–Ω–æ. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–º–µ–Ω–∏—Ç—å –ø–æ–∑–∂–µ, –æ—á–∏—Å—Ç–∏–≤ –¥–∞–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ —á–µ—Ä–µ–∑ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫.
      </div>
      <div class="gender-options">
        <button id="genderMale" class="gender-btn">
          <span class="gender-emoji">üë®‚Äçüíª</span>
          <span class="gender-label">–Ø –º—É–∂—á–∏–Ω–∞</span>
        </button>
        <button id="genderFemale" class="gender-btn">
          <span class="gender-emoji">üë©‚Äçüíª</span>
          <span class="gender-label">–Ø –∂–µ–Ω—â–∏–Ω–∞</span>
        </button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <div id="settingsModal" class="info-modal hidden">
    <div class="info-modal-inner settings-inner">
      <div class="info-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>

      <div class="settings-section">
        <div class="settings-section-title">–¢–µ–º–∞</div>
        <div class="settings-row">
          <button id="themeDarkBtn" class="settings-pill">–¢—ë–º–Ω–∞—è</button>
          <button id="themeLightBtn" class="settings-pill">–°–≤–µ—Ç–ª–∞—è</button>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">–û–±—Ä–∞—â–µ–Ω–∏–µ</div>
        <div class="settings-row">
          <button id="settingsGenderMale" class="settings-pill">üë® –ú—É–∂—á–∏–Ω–∞</button>
          <button id="settingsGenderFemale" class="settings-pill">üë© –ñ–µ–Ω—â–∏–Ω–∞</button>
        </div>
      </div>

      <div class="settings-footer">
        <button id="settingsTourBtn" class="settings-help-btn">–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</button>
        <button id="settingsCloseBtn" class="info-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –û–Ω–±–æ—Ä–¥–∏–Ω–≥ / –º–∏–Ω–∏-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
  <div id="tourModal" class="info-modal hidden">
    <div class="info-modal-inner tour-inner">
      <div class="tour-step-count" id="tourStepCount">–®–∞–≥ 1 –∏–∑ 4</div>
      <div class="info-title" id="tourTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üëã</div>
      <div class="info-body" id="tourBody">
        –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
      </div>
      <div class="tour-buttons">
        <button id="tourSkipBtn" class="tour-skip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        <button id="tourNextBtn" class="tour-next">–î–∞–ª—å—à–µ</button>
      </div>
    </div>
  </div>

  <script>
    function getLocalDateKey(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    const GENDER_KEY = "metta_user_gender";
    const THEME_KEY = "metta_theme";
    const ONBOARDING_KEY = "metta_tour_seen";

    let userGender = null;
    let currentStreak = 0;
    let currentTheme = "dark";

    function loadGenderFromStorage() {
      try {
        const g = localStorage.getItem(GENDER_KEY);
        if (g === "male" || g === "female") {
          userGender = g;
        }
      } catch (e) {}
    }

    function g(maleStr, femaleStr) {
      return userGender === "female" ? femaleStr : maleStr;
    }

    function loadThemeFromStorage() {
      try {
        const t = localStorage.getItem(THEME_KEY);
        if (t === "dark" || t === "light") {
          currentTheme = t;
        } else {
          currentTheme = "dark";
        }
      } catch (e) {
        currentTheme = "dark";
      }
      applyTheme(currentTheme, false);
    }

    function applyTheme(theme, save = true) {
      currentTheme = theme === "light" ? "light" : "dark";
      if (currentTheme === "light") {
        document.body.classList.add("light-theme");
      } else {
        document.body.classList.remove("light-theme");
      }
      if (save) {
        try {
          localStorage.setItem(THEME_KEY, currentTheme);
        } catch (e) {}
      }
      updateSettingsThemeButtons();
      updateWaterGradientForTheme();
    }

    let workMinutes = 25;
    let breakMinutes = 5;
    let remainingSeconds = workMinutes * 60;
    let totalSecondsCurrentPhase = remainingSeconds;
    let isFocus = true;
    let isRunning = false;
    let timerInterval = null;
    let cycles = 0;
    let pendingPhase = null;

    let isCustomModeActive = false;

    const STREAK_DATE_KEY = "metta_streak_date";
    const STREAK_VALUE_KEY = "metta_streak_value";
    const STREAK_LAST_UPDATED_KEY = "metta_streak_updated";
    const STREAK_MILESTONE_SHOWN_KEY = "metta_streak_milestone_shown";

    const CYCLES_DATE_KEY = "metta_cycles_date";
    const CYCLES_VALUE_KEY = "metta_cycles_value";

    const timerEl = document.getElementById('timer');
    const phaseLabelEl = document.getElementById('phaseLabel');
    const statusEl = document.getElementById('status');
    const cyclesEl = document.getElementById('cycles');
    const startPauseBtn = document.getElementById('startPauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const tipTextEl = document.querySelector('.tips-text');
    const modeButtons = document.querySelectorAll('.mode-btn');
    const customModeBtn = document.getElementById('customModeBtn');
    const customInputs = document.getElementById('customInputs');
    const customWorkInput = document.getElementById('customWork');
    const customBreakInput = document.getElementById('customBreak');
    const applyCustomBtn = document.getElementById('applyCustom');
    const achBadges = document.querySelectorAll('.ach-badge');
    const nextTipBtn = document.getElementById('nextTipBtn');

    const streakIconEl = document.getElementById('streakIcon');
    const streakValueEl = document.getElementById('streakValue');
    const streakStatusEl = document.getElementById('streakStatus');
    const streakMain = document.getElementById('streakMain');

    const phaseModal = document.getElementById('phaseModal');
    const phaseModalTitle = document.getElementById('phaseModalTitle');
    const phaseModalText = document.getElementById('phaseModalText');
    const phaseModalNote = document.getElementById('phaseModalNote');
    const phaseModalBtn = document.getElementById('phaseModalBtn');

    const featurePill = document.getElementById('featurePill');

    const waterRect = document.getElementById('waterRect');
    const timerCircle = document.querySelector('.timer-circle');

    const infoModal = document.getElementById('infoModal');
    const infoIcon = document.getElementById('infoIcon');
    const infoTitle = document.getElementById('infoTitle');
    const infoStatus = document.getElementById('infoStatus');
    const infoBody = document.getElementById('infoBody');
    const infoCloseBtn = document.getElementById('infoCloseBtn');

    const genderModal = document.getElementById('genderModal');
    const genderMaleBtn = document.getElementById('genderMale');
    const genderFemaleBtn = document.getElementById('genderFemale');

    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const themeDarkBtn = document.getElementById('themeDarkBtn');
    const themeLightBtn = document.getElementById('themeLightBtn');
    const settingsGenderMale = document.getElementById('settingsGenderMale');
    const settingsGenderFemale = document.getElementById('settingsGenderFemale');
    const settingsCloseBtn = document.getElementById('settingsCloseBtn');
    const settingsTourBtn = document.getElementById('settingsTourBtn');

    const tourModal = document.getElementById('tourModal');
    const tourStepCountEl = document.getElementById('tourStepCount');
    const tourTitleEl = document.getElementById('tourTitle');
    const tourBodyEl = document.getElementById('tourBody');
    const tourSkipBtn = document.getElementById('tourSkipBtn');
    const tourNextBtn = document.getElementById('tourNextBtn');

    let audioCtx = null;

    function ensureAudioCtx() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === "suspended") {
        audioCtx.resume();
      }
    }

    function vibrate(pattern = 20) {
      try {
        if (navigator.vibrate) {
          navigator.vibrate(pattern);
        }
      } catch (e) {}
    }

    function playTapSound() {
      try {
        ensureAudioCtx();
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(520, now);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.14, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.15);
        osc.start(now);
        osc.stop(now + 0.18);
      } catch (e) {}
    }

    function tactileTap() {
      playTapSound();
      vibrate(25);
    }

    function playNotificationSound() {
      try {
        ensureAudioCtx();

        function beep(atTime, freq) {
          const o = audioCtx.createOscillator();
          const gGain = audioCtx.createGain();
          o.type = "sine";
          o.frequency.setValueAtTime(freq, atTime);
          o.connect(gGain);
          gGain.connect(audioCtx.destination);
          gGain.gain.setValueAtTime(0.0001, atTime);
          gGain.gain.exponentialRampToValueAtTime(0.18, atTime + 0.01);
          gGain.gain.exponentialRampToValueAtTime(0.0001, atTime + 0.35);
          o.start(atTime);
          o.stop(atTime + 0.4);
        }

        const now = audioCtx.currentTime;
        beep(now, 880);
        beep(now + 0.5, 880);
        beep(now + 1.0, 880);
        vibrate([40, 30, 40]);
      } catch (e) {}
    }

    function isPortrait() {
      return window.matchMedia &&
             window.matchMedia("(orientation: portrait)").matches;
    }

    // —Å–æ–≤–µ—Ç—ã: –¥–ª–∏–Ω–Ω—ã–µ –∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ (–¥–ª—è "–°–≤–æ–π —Ä–µ–∂–∏–º" –≤ –ø–æ—Ä—Ç—Ä–µ—Ç–µ)
    const focusTipsFull = [
      "–°–ª–µ–¥–∏, —á—Ç–æ–±—ã –ø–æ—è—Å–Ω–∏—Ü–∞ –æ–ø–∏—Ä–∞–ª–∞—Å—å –Ω–∞ —Å–ø–∏–Ω–∫—É ‚Äî –Ω–µ —Ç—è–Ω–∏—Å—å –∫–æ—Ä–ø—É—Å–æ–º –∫ —ç–∫—Ä–∞–Ω—É.",
      "–û—Ç—Ä–µ–≥—É–ª–∏—Ä—É–π –≤—ã—Å–æ—Ç—É –∫—Ä–µ—Å–ª–∞ —Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ç–æ–ø—ã —Å—Ç–æ—è–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ –ø–æ–ª—É.",
      "–≠–∫—Ä–∞–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥–ª–∞–∑ ‚Äî —à–µ—è —Å–∫–∞–∂–µ—Ç —Å–ø–∞—Å–∏–±–æ.",
      "–ü—Ä–∏–∂–º–∏ –ª–æ–ø–∞—Ç–∫–∏ –∫ —Å–ø–∏–Ω–∫–µ –∫—Ä–µ—Å–ª–∞ –∏ –æ—Ç–ø—É—Å—Ç–∏ –ø–ª–µ—á–∏ –≤–Ω–∏–∑.",
      "–ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—à—å –∑–∞ –Ω–æ—É—Ç–±—É–∫–æ–º ‚Äî –ø–æ–¥–Ω–∏–º–∏ –µ–≥–æ –Ω–∞ –ø–æ–¥—Å—Ç–∞–≤–∫—É, –∞ –Ω–µ —à–µ—é."
    ];

    const breakTipsFull = [
      "–í—Å—Ç–∞–Ω—å, –ø—Ä–æ–π–¥–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ –∏ —Å–¥–µ–ª–∞–π 3‚Äì5 –∫—Ä—É–≥–æ–≤ –ø–ª–µ—á–∞–º–∏ –≤–ø–µ—Ä—ë–¥-–Ω–∞–∑–∞–¥.",
      "–ú–µ–¥–ª–µ–Ω–Ω–æ –Ω–∞–∫–ª–æ–Ω–∏ –≥–æ–ª–æ–≤—É –≤–ø—Ä–∞–≤–æ-–≤–ª–µ–≤–æ, –±–µ–∑ —Ä–µ–∑–∫–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π.",
      "–ü–æ–¥–Ω–∏–º–∏ —Ä—É–∫–∏ –≤–≤–µ—Ä—Ö, –ø–æ—Ç—è–Ω–∏—Å—å –∏ —Å–¥–µ–ª–∞–π –≥–ª—É–±–æ–∫–∏–π –≤–¥–æ—Ö-–≤—ã–¥–æ—Ö.",
      "–°–¥–µ–ª–∞–π –ø–∞—Ä—É —à–∞–≥–æ–≤, –ø–æ—Å–º–æ—Ç—Ä–∏ –≤–¥–∞–ª—å –≤ –æ–∫–Ω–æ ‚Äî –¥–∞–π –≥–ª–∞–∑–∞–º –ø–µ—Ä–µ—Ä—ã–≤.",
      "–ü–æ—Ç—Ä—è—Å–∏ –∫–∏—Å—Ç—è–º–∏, —Ä–∞–∑–æ–º–Ω–∏ –ø–∞–ª—å—Ü—ã ‚Äî –æ–Ω–∏ —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–µ—Å—å –¥–µ–Ω—å."
    ];

    const focusTipsShort = [
      "–ü–ª–æ—Ç–Ω–æ –ø—Ä–∏–∂–º–∏ –ø–æ—è—Å–Ω–∏—Ü—É –∫ —Å–ø–∏–Ω–∫–µ.",
      "–ö–æ–ª–µ–Ω–∏ –ø–æ–¥ —É–≥–ª–æ–º ~90¬∞, —Å—Ç–æ–ø—ã –Ω–∞ –ø–æ–ª—É.",
      "–≠–∫—Ä–∞–Ω –¥–µ—Ä–∂–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥–ª–∞–∑.",
      "–û–ø—É—Å—Ç–∏ –ø–ª–µ—á–∏ –≤–Ω–∏–∑, —Ä–∞—Å—Å–ª–∞–±—å —à–µ—é.",
      "–ù–æ—É—Ç–±—É–∫ –ø–æ–¥–Ω–∏–º–∏, –∞ –Ω–µ —à–µ—é."
    ];

    const breakTipsShort = [
      "–ü—Ä–æ–π–¥–∏ –ø–∞—Ä—É —à–∞–≥–æ–≤ –∏ —Ä–∞–∑–æ–º–Ω–∏ –ø–ª–µ—á–∏.",
      "–ú–µ–¥–ª–µ–Ω–Ω–æ –Ω–∞–∫–ª–æ–Ω–∏ –≥–æ–ª–æ–≤—É –≤–ø—Ä–∞–≤–æ-–≤–ª–µ–≤–æ.",
      "–ü–æ—Ç—è–Ω–∏—Å—å –≤–≤–µ—Ä—Ö –∏ –≥–ª—É–±–æ–∫–æ –≤–¥–æ—Ö–Ω–∏.",
      "–°–¥–µ–ª–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ –∏ –≥–ª—è–Ω—å –≤–¥–∞–ª—å.",
      "–ü–æ—Ç—Ä—è—Å–∏ –∫–∏—Å—Ç—è–º–∏ –∏ —Ä–∞–∑–æ–º–Ω–∏ –ø–∞–ª—å—Ü—ã."
    ];

    function getActiveFocusTips() {
      return isCustomModeActive && isPortrait() ? focusTipsShort : focusTipsFull;
    }

    function getActiveBreakTips() {
      return isCustomModeActive && isPortrait() ? breakTipsShort : breakTipsFull;
    }

    let focusTipIndex = 0;
    let breakTipIndex = 0;

    function getCurrentTip() {
      if (isFocus) {
        const list = getActiveFocusTips();
        const idx = focusTipIndex % list.length;
        return list[idx];
      } else {
        const list = getActiveBreakTips();
        const idx = breakTipIndex % list.length;
        return list[idx];
      }
    }

    function updateTipText() {
      const text = getCurrentTip();
      tipTextEl.innerHTML = isFocus
        ? `<strong>–°–æ–≤–µ—Ç:</strong> ${text}`
        : `<strong>–ü–µ—Ä–µ—Ä—ã–≤:</strong> ${text}`;
    }

    function nextTip() {
      if (isFocus) {
        const list = getActiveFocusTips();
        focusTipIndex = (focusTipIndex + 1) % list.length;
      } else {
        const list = getActiveBreakTips();
        breakTipIndex = (breakTipIndex + 1) % list.length;
      }
      updateTipText();
    }

    function resetTipIndexForPhase() {
      if (isFocus) {
        focusTipIndex = 0;
      } else {
        breakTipIndex = 0;
      }
      updateTipText();
    }

    window.addEventListener("resize", () => {
      updateTipText();
    });

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function updateAchievements() {
      achBadges.forEach(badge => {
        const threshold = parseInt(badge.getAttribute('data-threshold'), 10);
        if (cycles >= threshold) {
          badge.classList.add('earned');
        } else {
          badge.classList.remove('earned');
        }
      });
    }

    function pluralRu(n, forms) {
      const nAbs = Math.abs(n) % 100;
      const n1 = nAbs % 10;
      if (nAbs > 10 && nAbs < 20) return forms[2];
      if (n1 > 1 && n1 < 5) return forms[1];
      if (n1 === 1) return forms[0];
      return forms[2];
    }

    function updateStreakDisplay(streak) {
      currentStreak = streak;
      streakValueEl.textContent = `${streak} ${pluralRu(streak, ["–¥–µ–Ω—å", "–¥–Ω—è", "–¥–Ω–µ–π"])} –ø–æ–¥—Ä—è–¥`;

      streakIconEl.classList.remove("low", "mid", "high");
      let statusText = "";
      if (streak <= 1) {
        streakIconEl.classList.add("low");
        statusText = "–•–æ—Ä–æ—à–µ–µ –Ω–∞—á–∞–ª–æ. –ü–æ–ø—Ä–æ–±—É–π —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Ä–∏—é.";
      } else if (streak <= 3) {
        streakIconEl.classList.add("mid");
        statusText = "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚Äî —Å–∏–ª–∞. –°–ø–∏–Ω–∞ —É–∂–µ —á—É–≤—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É.";
      } else if (streak <= 7) {
        streakIconEl.classList.add("mid");
        statusText = "–°–µ—Ä–∏—è –∫–∞–∫ —É Duolingo. –û—Ä–≥–∞–Ω–∏–∑–º —Å–∫–∞–∂–µ—Ç —Å–ø–∞—Å–∏–±–æ.";
      } else {
        streakIconEl.classList.add("high");
        statusText = "–≠—Ç–æ —É–∂–µ –ø—Ä–∏–≤—ã—á–∫–∞. –¢—ã —Ä–µ–∞–ª—å–Ω–æ –∑–∞–±–æ—Ç–∏—à—å—Å—è –æ —Å–µ–±–µ.";
      }
      streakStatusEl.textContent = statusText;

      const fireEl = document.getElementById('streakFire');
      if (fireEl) {
        const maxRef = 15;
        const clamped = Math.max(0, Math.min(streak, maxRef));
        const baseSize = 22;
        const maxExtra = 14;
        const size = baseSize + (maxExtra * (clamped / maxRef));
        fireEl.style.fontSize = size + "px";

        const baseGlow = 4;
        const maxGlow = 12;
        const glow = baseGlow + (maxGlow - baseGlow) * (clamped / maxRef);
        const color = streak >= 8
          ? 'rgba(234,179,8,1)'
          : 'rgba(249,115,22,0.95)';
        fireEl.style.filter = `drop-shadow(0 0 ${glow}px ${color})`;
      }
    }

    function getStreakPraise(streak) {
      if (streak <= 1) {
        return g(
          "–ü–µ—Ä–≤—ã–π –¥–µ–Ω—å ‚Äî —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —É–∂–µ –ø—Ä–∏–Ω—è—Ç–æ. –¢—ã –≤—ã–±—Ä–∞–ª –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ.",
          "–ü–µ—Ä–≤—ã–π –¥–µ–Ω—å ‚Äî —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —É–∂–µ –ø—Ä–∏–Ω—è—Ç–æ. –¢—ã –≤—ã–±—Ä–∞–ª–∞ –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ."
        );
      } else if (streak === 2) {
        return g(
          "–í—Ç–æ—Ä–æ–π –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥ ‚Äî —Ç—ã –Ω–µ –±—Ä–æ—Å–∏–ª –Ω–∞ —Å—Ç–∞—Ä—Ç–µ. –¢–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞—Å—Ç–æ—è—â–∞—è –ø—Ä–∏–≤—ã—á–∫–∞.",
          "–í—Ç–æ—Ä–æ–π –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥ ‚Äî —Ç—ã –Ω–µ –±—Ä–æ—Å–∏–ª–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ. –¢–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞—Å—Ç–æ—è—â–∞—è –ø—Ä–∏–≤—ã—á–∫–∞."
        );
      } else if (streak <= 4) {
        return "–£–∂–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ —Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å—Å—è –∫ —Ç–∞–π–º–µ—Ä—É. –°–ø–∏–Ω–∞ –∏ –≥–æ–ª–æ–≤–∞ —Å–∫–∞–∂—É—Ç —Å–ø–∞—Å–∏–±–æ.";
      } else if (streak <= 7) {
        return "–ù–µ–¥–µ–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Å–µ—Å—Å–∏–π ‚Äî —ç—Ç–æ —Å–µ—Ä—å—ë–∑–Ω—ã–π –≤–∫–ª–∞–¥ –≤ —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –û—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.";
      } else if (streak <= 10) {
        return "10 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ ‚Äî –º–æ—â–Ω–∞—è —Å–µ—Ä–∏—è. –¢—ã –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ —Å–µ–±–µ –∫–∞–∫ –∫ —Ü–µ–Ω–Ω–æ–º—É —Ä–µ—Å—É—Ä—Å—É.";
      } else if (streak <= 15) {
        return "–ë–æ–ª—å—à–µ –¥–≤—É—Ö –Ω–µ–¥–µ–ª—å –ø–æ–¥—Ä—è–¥ ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º —É–∂–µ –ø—Ä–∏–≤—ã–∫–∞–µ—Ç –∫ –Ω–æ–≤–æ–º—É, –±–æ–ª–µ–µ –∑–¥–æ—Ä–æ–≤–æ–º—É —Ä–µ–∂–∏–º—É.";
      } else if (streak <= 21) {
        return "–û–∫–æ–ª–æ —Ç—Ä—ë—Ö –Ω–µ–¥–µ–ª—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ ‚Äî —ç—Ç–æ —É—Ä–æ–≤–µ–Ω—å —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –∫—É—Ä—Å.";
      } else if (streak <= 30) {
        return g(
          "–ú–µ—Å—è—Ü –ø–æ—á—Ç–∏ –±–µ–∑ —Å—Ä—ã–≤–æ–≤ ‚Äî –æ—á–µ–Ω—å –∫—Ä—É—Ç–æ. –¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª –±–æ–ª—å—à—É—é —Ä–∞–±–æ—Ç—É.",
          "–ú–µ—Å—è—Ü –ø–æ—á—Ç–∏ –±–µ–∑ —Å—Ä—ã–≤–æ–≤ ‚Äî –æ—á–µ–Ω—å –∫—Ä—É—Ç–æ. –¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª–∞ –±–æ–ª—å—à—É—é —Ä–∞–±–æ—Ç—É."
        );
      } else {
        return "–°–µ—Ä–∏—è –∫–∞–∫ —É –ø—Ä–æ—Ñ–∏: —Ç—ã –≤—ã—Å—Ç—Ä–æ–∏–ª(–∞) —É—Å—Ç–æ–π—á–∏–≤—É—é —Å–∏—Å—Ç–µ–º—É –∑–∞–±–æ—Ç—ã –æ —Å–µ–±–µ. –û—á–µ–Ω—å –∑–∞—Å–ª—É–∂–µ–Ω–Ω–æ–µ —É–≤–∞–∂–µ–Ω–∏–µ.".replace("(–∞)", userGender === "female" ? "–∞" : "");
      }
    }

    function getStreakMilestoneText(streak) {
      if (streak === 2) {
        return g(
          "–í—Ç–æ—Ä–æ–π –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥ ‚Äî —Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ —É–∂–µ –ø–æ–∑–∞–¥–∏. –ü—Ä–æ–¥–æ–ª–∂–∞–π, –ø—Ä–∏–≤—ã—á–∫–∞ –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è.",
          "–í—Ç–æ—Ä–æ–π –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥ ‚Äî —Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ —É–∂–µ –ø–æ–∑–∞–¥–∏. –ü—Ä–æ–¥–æ–ª–∂–∞–π, –ø—Ä–∏–≤—ã—á–∫–∞ –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è."
        );
      } else if (streak === 4) {
        return "–ß–µ—Ç—ã—Ä–µ –¥–Ω—è –ø–æ–¥—Ä—è–¥ ‚Äî —Ç—ã –Ω–µ –¥–∞—ë—à—å —Å–µ–±–µ –∑–∞–±—ã—Ç—å –ø—Ä–æ –ø–∞—É–∑—ã –∏ —Ñ–æ–∫—É—Å. –ö—Ä—É—Ç–æ–π —Ç–µ–º–ø.";
      } else if (streak === 7) {
        return "–ù–µ–¥–µ–ª—è —Å METTA ‚Äî —Ç–≤–æ–π –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫ —Ç–æ—á–Ω–æ —ç—Ç–æ —Ü–µ–Ω–∏—Ç. –û—Ç–ª–∏—á–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å.";
      } else if (streak === 10) {
        return "10 –¥–Ω–µ–π —Ñ–æ–∫—É—Å–∞ –∏ –ø–∞—É–∑ ‚Äî —ç—Ç–æ –æ—á–µ–Ω—å —Å–µ—Ä—å—ë–∑–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Å–µ–±–µ –∏ —Å–≤–æ–µ–π —Ä–∞–±–æ—Ç–µ.";
      } else if (streak === 15) {
        return "15 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ ‚Äî —ç—Ç–æ —É–∂–µ –Ω–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç, –∞ —Å—Ç–∏–ª—å –∂–∏–∑–Ω–∏. –¢—ã –±–æ–ª—å—à–æ–π –º–æ–ª–æ–¥–µ—Ü.";
      } else if (streak === 21) {
        return g(
          "21 –¥–µ–Ω—å ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å—Ä–æ–∫, —á—Ç–æ–±—ã –∑–∞–∫—Ä–µ–ø–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É. –¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª –æ–≥—Ä–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É.",
          "21 –¥–µ–Ω—å ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å—Ä–æ–∫, —á—Ç–æ–±—ã –∑–∞–∫—Ä–µ–ø–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É. –¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª–∞ –æ–≥—Ä–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É."
        );
      } else if (streak === 30) {
        return "30 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ ‚Äî —ç—Ç–æ —É—Ä–æ–≤–µ–Ω—å —É–≤–∞–∂–µ–Ω–∏—è –∫ —Å–µ–±–µ, –∫–æ—Ç–æ—Ä—ã–º –º–æ–∂–Ω–æ –≥–æ—Ä–¥–∏—Ç—å—Å—è.";
      } else if (streak > 30) {
        return g(
          `–£–∂–µ ${streak} ${pluralRu(streak, ["–¥–µ–Ω—å", "–¥–Ω—è", "–¥–Ω–µ–π"])} –ø–æ–¥—Ä—è–¥ ‚Äî —Ç—ã –¥–µ—Ä–∂–∏—à—å —Å–µ—Ä–∏—é –∫–∞–∫ —á–µ–º–ø–∏–æ–Ω.`,
          `–£–∂–µ ${streak} ${pluralRu(streak, ["–¥–µ–Ω—å", "–¥–Ω—è", "–¥–Ω–µ–π"])} –ø–æ–¥—Ä—è–¥ ‚Äî —Ç—ã –¥–µ—Ä–∂–∏—à—å —Å–µ—Ä–∏—é –∫–∞–∫ —á–µ–º–ø–∏–æ–Ω–∫–∞.`
        );
      }
      return "–°–∏–ª—å–Ω–∞—è —Å–µ—Ä–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Å–≤–æ—ë–º —Ä–∏—Ç–º–µ ‚Äî –±–µ–∑ –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º–∞, –Ω–æ —Å –∑–∞–±–æ—Ç–æ–π –æ —Å–µ–±–µ.";
    }

    function maybeShowStreakMilestone(prevStreak, newStreak, todayStr) {
      if (newStreak <= 1) return;

      try {
        const shownDate = localStorage.getItem(STREAK_MILESTONE_SHOWN_KEY);
        if (shownDate === todayStr) return;

        const thresholds = [2, 4, 7, 10, 15, 21, 30];
        const hit = thresholds.some(t => prevStreak < t && newStreak >= t);

        if (!hit && newStreak <= 30) return;
        if (newStreak > 30 && !(prevStreak < newStreak)) return;

        const svg = streakIconEl.querySelector('span')?.outerHTML || "";

        openInfoModal({
          svgHTML: svg,
          title: "–°–∏–ª—å–Ω–∞—è —Å–µ—Ä–∏—è",
          statusText: `${newStreak} ${pluralRu(newStreak, ["–¥–µ–Ω—å –ø–æ–¥—Ä—è–¥", "–¥–Ω—è –ø–æ–¥—Ä—è–¥", "–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥"])}`,
          statusEarned: true,
          body: getStreakMilestoneText(newStreak)
        });

        localStorage.setItem(STREAK_MILESTONE_SHOWN_KEY, todayStr);
      } catch (e) {}
    }

    function initStreak() {
      try {
        const today = new Date();
        const todayStr = getLocalDateKey(today);

        const lastUpdated = localStorage.getItem(STREAK_LAST_UPDATED_KEY);
        const prevStreak = parseInt(localStorage.getItem(STREAK_VALUE_KEY) || "0", 10);

        let streak = prevStreak;

        if (lastUpdated === todayStr && streak > 0) {
          updateStreakDisplay(streak);
          return;
        }

        const baseDayStr = localStorage.getItem(STREAK_DATE_KEY);

        if (!baseDayStr) {
          streak = 1;
        } else {
          const [by, bm, bd] = baseDayStr.split("-").map(Number);
          const [ty, tm, td] = todayStr.split("-").map(Number);

          const baseDate = new Date(by, bm - 1, bd);
          const todayDate = new Date(ty, tm - 1, td);

          const diffDays = Math.round(
            (todayDate - baseDate) / (1000 * 60 * 60 * 24)
          );

          if (diffDays === 0) {
            if (!streak || streak < 1) streak = 1;
          } else if (diffDays === 1) {
            streak = (isFinite(streak) && streak > 0) ? streak + 1 : 1;
          } else {
            streak = 1;
          }
        }

        localStorage.setItem(STREAK_DATE_KEY, todayStr);
        localStorage.setItem(STREAK_VALUE_KEY, String(streak));
        localStorage.setItem(STREAK_LAST_UPDATED_KEY, todayStr);

        updateStreakDisplay(streak);
        maybeShowStreakMilestone(prevStreak, streak, todayStr);
      } catch (e) {}
    }

    function initCyclesToday() {
      try {
        const todayStr = getLocalDateKey();
        const lastDateStr = localStorage.getItem(CYCLES_DATE_KEY);
        let stored = parseInt(localStorage.getItem(CYCLES_VALUE_KEY) || "0", 10);

        if (!lastDateStr || lastDateStr !== todayStr) {
          cycles = 0;
          localStorage.setItem(CYCLES_DATE_KEY, todayStr);
          localStorage.setItem(CYCLES_VALUE_KEY, "0");
        } else {
          cycles = isFinite(stored) && stored >= 0 ? stored : 0;
        }
      } catch (e) {
        cycles = 0;
      }
    }

    function saveCyclesToday() {
      try {
        const todayStr = getLocalDateKey();
        localStorage.setItem(CYCLES_DATE_KEY, todayStr);
        localStorage.setItem(CYCLES_VALUE_KEY, String(cycles));
      } catch (e) {}
    }

    function updateTimerFill() {
      if (!waterRect || !totalSecondsCurrentPhase || totalSecondsCurrentPhase <= 0) return;

      const elapsed = totalSecondsCurrentPhase - remainingSeconds;
      const ratio = Math.max(0, Math.min(1, elapsed / totalSecondsCurrentPhase));

      const fullH = 200;
      const h = fullH * ratio;
      const y = fullH - h;

      waterRect.setAttribute("height", h);
      waterRect.setAttribute("y", y);

      if (ratio >= 0.5) {
        timerCircle.classList.add('over-water');
      } else {
        timerCircle.classList.remove('over-water');
      }
    }

    function updateDisplay() {
      timerEl.textContent = formatTime(remainingSeconds);
      cyclesEl.textContent = `–ó–∞–≤–µ—Ä—à–µ–Ω–æ —Ü–∏–∫–ª–æ–≤: ${cycles}`;

      if (isFocus) {
        statusEl.classList.add('focus');
        statusEl.classList.remove('break');
        statusEl.querySelector('.status-label').textContent = "–†–µ–∂–∏–º —Ñ–æ–∫—É—Å–∞";
        phaseLabelEl.textContent = "–§–æ–∫—É—Å-—Å–µ—Å—Å–∏—è";
      } else {
        statusEl.classList.remove('focus');
        statusEl.classList.add('break');
        statusEl.querySelector('.status-label').textContent = "–ü–µ—Ä–µ—Ä—ã–≤";
        phaseLabelEl.textContent = "–ü–µ—Ä–µ—Ä—ã–≤ –¥–ª—è —Å–ø–∏–Ω—ã";
      }

      updateAchievements();
      updateTimerFill();
    }

    function showPhaseModal(type) {
      pendingPhase = type;

      if (type === "focusToBreak") {
        const nextCycle = cycles + 1;
        phaseModalTitle.textContent = "–§–æ–∫—É—Å-—Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úî";
        phaseModalText.textContent =
          `–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äî —ç—Ç–æ —É–∂–µ ${nextCycle}-–π —Ñ–æ–∫—É—Å-—Ü–∏–∫–ª —Å–µ–≥–æ–¥–Ω—è. –°–ø–∏–Ω–∞ –∏ –º–æ–∑–≥ –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã.`;
        phaseModalNote.textContent = "–ù–∞–∂–º–∏, –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—à—å –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø–µ—Ä–µ—Ä—ã–≤—É –∏ –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–∑–≥—Ä—É–∑–∏—Ç—å —Ç–µ–ª–æ.";
        phaseModalBtn.textContent = "–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–µ—Ä–µ—Ä—ã–≤—É";
      } else {
        phaseModalTitle.textContent = "–ü–µ—Ä–µ—Ä—ã–≤ –∑–∞–≤–µ—Ä—à—ë–Ω üí°";
        phaseModalText.textContent =
          "–ö–ª–∞—Å—Å, —á—Ç–æ –¥–∞—ë—à—å —Å–µ–±–µ –æ—Ç–¥—ã—Ö. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –º—è–≥–∫–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–¥–∞—á–µ –∏ –∑–∞–±—Ä–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω —Ñ–æ–∫—É—Å-—Ü–∏–∫–ª.";
        phaseModalNote.textContent = "–ù–∞–∂–º–∏, –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—à—å —Å–Ω–æ–≤–∞ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ.";
        phaseModalBtn.textContent = "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ñ–æ–∫—É—Å—É";
      }

      phaseModal.classList.remove("hidden");
      playNotificationSound();
    }

    function confirmPhaseChange() {
      if (!pendingPhase) return;

      if (pendingPhase === "focusToBreak") {
        cycles++;
        saveCyclesToday();
        isFocus = false;
        remainingSeconds = breakMinutes * 60;
        totalSecondsCurrentPhase = remainingSeconds;
      } else {
        isFocus = true;
        remainingSeconds = workMinutes * 60;
        totalSecondsCurrentPhase = remainingSeconds;
      }

      pendingPhase = null;
      resetTipIndexForPhase();
      updateDisplay();
      phaseModal.classList.add("hidden");
      startTimer();
    }

    function startTimer() {
      if (isRunning) return;
      isRunning = true;
      startPauseBtn.innerHTML = "<span>‚è∏</span><span>–ü–∞—É–∑–∞</span>";

      ensureAudioCtx();

      timerInterval = setInterval(() => {
        remainingSeconds--;
        if (remainingSeconds <= 0) {
          remainingSeconds = 0;
          updateTimerFill();
          clearInterval(timerInterval);
          isRunning = false;

          if (isFocus) {
            showPhaseModal("focusToBreak");
          } else {
            showPhaseModal("breakToFocus");
          }
        } else {
          timerEl.textContent = formatTime(remainingSeconds);
          updateTimerFill();
        }
      }, 1000);
    }

    function pauseTimer() {
      isRunning = false;
      startPauseBtn.innerHTML = "<span>‚ñ∂</span><span>–°—Ç–∞—Ä—Ç</span>";
      if (timerInterval) {
        clearInterval(timerInterval);
      }
    }

    function resetTimer() {
      pauseTimer();
      isFocus = true;
      remainingSeconds = workMinutes * 60;
      totalSecondsCurrentPhase = remainingSeconds;
      pendingPhase = null;
      phaseModal.classList.add("hidden");
      resetTipIndexForPhase();
      updateDisplay();
    }

    function openInfoModal(options) {
      const { svgHTML, title, statusText, statusEarned, body } = options;

      infoIcon.classList.remove("earned", "locked");
      if (statusEarned === true) {
        infoIcon.classList.add("earned");
      } else if (statusEarned === false) {
        infoIcon.classList.add("locked");
      }

      infoIcon.innerHTML = svgHTML || "";
      infoTitle.textContent = title || "";
      infoBody.textContent = body || "";

      infoStatus.textContent = statusText || "";
      infoStatus.classList.remove("info-status-earned");
      if (statusEarned) {
        infoStatus.classList.add("info-status-earned");
      }

      infoModal.classList.remove("hidden");
    }

    function closeInfoModal() {
      infoModal.classList.add("hidden");
    }

    function showGenderModalIfNeeded() {
      if (!genderModal) return;
      if (!userGender) {
        genderModal.classList.remove("hidden");
      }
    }

    function setGender(gender) {
      userGender = gender;
      try {
        localStorage.setItem(GENDER_KEY, gender);
      } catch (e) {}
      if (genderModal && !genderModal.classList.contains("hidden")) {
        genderModal.classList.add("hidden");
      }
      updateStreakDisplay(currentStreak);
      maybeStartTourAuto();
      updateSettingsGenderButtons();
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
    function updateSettingsThemeButtons() {
      if (!themeDarkBtn || !themeLightBtn) return;
      themeDarkBtn.classList.toggle("settings-pill-active", currentTheme === "dark");
      themeLightBtn.classList.toggle("settings-pill-active", currentTheme === "light");
    }

    function updateSettingsGenderButtons() {
      if (!settingsGenderMale || !settingsGenderFemale) return;
      settingsGenderMale.classList.toggle("settings-pill-active", userGender === "male");
      settingsGenderFemale.classList.toggle("settings-pill-active", userGender === "female");
    }

    function openSettingsModal() {
      settingsModal.classList.remove("hidden");
      updateSettingsThemeButtons();
      updateSettingsGenderButtons();
    }

    function closeSettingsModal() {
      settingsModal.classList.add("hidden");
    }

    // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –≤–æ–¥—ã –ø–æ —Ç–µ–º–µ
    function updateWaterGradientForTheme() {
      if (!waterRect) return;
      if (currentTheme === "light") {
        waterRect.setAttribute("fill", "url(#waterGradientLight)");
      } else {
        waterRect.setAttribute("fill", "url(#waterGradientDark)");
      }
    }

    // –û–Ω–±–æ—Ä–¥–∏–Ω–≥ / —Ç—É—Ä
    const tourSteps = [
      {
        title: "–¢–∞–π–º–µ—Ä –∏ —Ä–µ–∂–∏–º—ã",
        body: "–ó–¥–µ—Å—å —Ç—ã –∑–∞–ø—É—Å–∫–∞–µ—à—å Pomodoro: –≤—ã–±–∏—Ä–∞–µ—à—å —Ä–µ–∂–∏–º, –Ω–∞–∂–∏–º–∞–µ—à—å ¬´–°—Ç–∞—Ä—Ç¬ª –∏ —á–µ—Ä–µ–¥—É–µ—à—å —Ñ–æ–∫—É—Å –∏ –ø–µ—Ä–µ—Ä—ã–≤."
      },
      {
        title: "–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —Å–µ—Ä–∏—è –¥–Ω–µ–π",
        body: "–í –±–ª–æ–∫–µ ¬´–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è¬ª –∏ ¬´–°–µ—Ä–∏—è –¥–Ω–µ–π¬ª –≤–∏–¥–Ω–æ, –∫–∞–∫ —Ç—ã –¥–µ—Ä–∂–∏—à—å —Ä–∏—Ç–º. –ù–∞–∂–º–∏ –Ω–∞ –∑–Ω–∞—á–æ–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –ø–æ—Ö–≤–∞–ª—É."
      },
      {
        title: "–°–æ–≤–µ—Ç—ã –¥–ª—è —Å–ø–∏–Ω—ã",
        body: "–í–Ω–∏–∑—É –ø–æ—è–≤–ª—è—é—Ç—Å—è –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø–æ—Å–∞–¥–∫–µ –∏ –ø–µ—Ä–µ—Ä—ã–≤–∞–º. –ú–µ–Ω—è–π –∏—Ö –ø–æ –∫–Ω–æ–ø–∫–µ ¬´–°–º–µ–Ω–∏—Ç—å¬ª."
      },
      {
        title: "–§–∏—à–∫–∞ METTA –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
        body: "–ù–∞–∂–º–∏ ¬´–§–∏—à–∫–∞ METTA¬ª, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø—Ä–æ –≥–∏–±–∫–∏–π ¬´–ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫¬ª —Å–ø–∏–Ω–∫–∏, –∞ —á–µ—Ä–µ–∑ –∑–Ω–∞—á–æ–∫ ‚öô –º–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å —Ç–µ–º—É (—Ç—ë–º–Ω—É—é –∏–ª–∏ —Å–≤–µ—Ç–ª—É—é) –∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ."
      }
    ];

    let tourIndex = 0;

    function renderTourStep() {
      const total = tourSteps.length;
      if (tourIndex < 0) tourIndex = 0;
      if (tourIndex >= total) tourIndex = total - 1;
      const step = tourSteps[tourIndex];
      tourStepCountEl.textContent = `–®–∞–≥ ${tourIndex + 1} –∏–∑ ${total}`;
      tourTitleEl.textContent = step.title;
      tourBodyEl.textContent = step.body;
      tourNextBtn.textContent = tourIndex === total - 1 ? "–ì–æ—Ç–æ–≤–æ" : "–î–∞–ª—å—à–µ";
    }

    function openTour() {
      tourIndex = 0;
      renderTourStep();
      tourModal.classList.remove("hidden");
    }

    function closeTour(markSeen = true) {
      tourModal.classList.add("hidden");
      if (markSeen) {
        try {
          localStorage.setItem(ONBOARDING_KEY, "1");
        } catch (e) {}
      }
    }

    function maybeStartTourAuto() {
      try {
        const seen = localStorage.getItem(ONBOARDING_KEY);
        if (seen === "1") return;
        if (!userGender) return;
        openTour();
      } catch (e) {}
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ---

    startPauseBtn.addEventListener('click', () => {
      tactileTap();
      if (isRunning) {
        pauseTimer();
      } else {
        startTimer();
      }
    });

    resetBtn.addEventListener('click', () => {
      tactileTap();
      resetTimer();
    });

    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        tactileTap();
        modeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        if (btn === customModeBtn) {
          isCustomModeActive = true;
          customInputs.style.display = 'flex';
          resetTipIndexForPhase();
        } else {
          isCustomModeActive = false;
          customInputs.style.display = 'none';
          workMinutes = parseInt(btn.dataset.work, 10);
          breakMinutes = parseInt(btn.dataset.break, 10);
          resetTimer();
        }
      });
    });

    applyCustomBtn.addEventListener('click', () => {
      tactileTap();
      const w = parseInt(customWorkInput.value, 10);
      const b = parseInt(customBreakInput.value, 10);
      if (!isNaN(w) && !isNaN(b) && w > 0 && b > 0) {
        workMinutes = w;
        breakMinutes = b;
        resetTimer();
      }
    });

    nextTipBtn.addEventListener('click', () => {
      tactileTap();
      nextTip();
    });

    phaseModalBtn.addEventListener('click', () => {
      tactileTap();
      confirmPhaseChange();
    });

    achBadges.forEach(badge => {
      badge.addEventListener('click', () => {
        tactileTap();
        const threshold = parseInt(badge.getAttribute('data-threshold'), 10);
        const earned = cycles >= threshold;
        const svg = badge.querySelector('svg')?.outerHTML || "";
        const title = badge.getAttribute('data-title') || "";
        const desc = badge.getAttribute('data-desc') || "";

        const statusText = earned
          ? "–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è üéâ"
          : `–ü–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ. –ù—É–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å ${threshold} ${pluralRu(threshold, ["—Ü–∏–∫–ª", "—Ü–∏–∫–ª–∞", "—Ü–∏–∫–ª–æ–≤"])} –∑–∞ –¥–µ–Ω—å.`;

        openInfoModal({
          svgHTML: svg,
          title,
          statusText,
          statusEarned: earned,
          body: desc
        });
      });
    });

    featurePill.addEventListener('click', () => {
      tactileTap();
      const svg = `
        <svg viewBox="0 0 24 24">
          <path d="M7 4C7 4 9 7 9 9C9 10.5 8 12 8 13.5C8 15.5 9.5 17 12 17C14.5 17 16 15.5 16 13.5C16 12 15 10.5 15 9C15 7 17 4 17 4" />
        </svg>
      `;
      openInfoModal({
        svgHTML: svg,
        title: "–§–∏—à–∫–∞ METTA",
        statusText: "–ì–∏–±–∫–∏–π ¬´–ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫¬ª —Å–ø–∏–Ω–∫–∏",
        statusEarned: null,
        body: "–°–ø–∏–Ω–∫–∞ –∫—Ä–µ—Å–µ–ª METTA –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–∑–≥–∏–±—ã –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞ –∏ –º—è–≥–∫–æ –¥–≤–∏–≥–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Ç–æ–±–æ–π. –ó–∞ —Å—á—ë—Ç —ç—Ç–æ–≥–æ –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ø–æ—è—Å–Ω–∏—Ü—É –∏ –ø—Ä–æ—â–µ —Å–∏–¥–µ—Ç—å –¥–æ–ª–≥–æ –±–µ–∑ –æ—â—É—â–µ–Ω–∏—è ¬´–∫–∞–º–µ–Ω–Ω–æ–π¬ª —Å–ø–∏–Ω—ã."
      });
    });

    streakMain.addEventListener('click', () => {
      tactileTap();
      let streak = parseInt(localStorage.getItem(STREAK_VALUE_KEY) || "0", 10);
      if (!isFinite(streak) || streak < 0) streak = 0;

      const svg = streakIconEl.querySelector('span')?.outerHTML || "";
      const statusText = `${streak} ${pluralRu(streak, ["–¥–µ–Ω—å –ø–æ–¥—Ä—è–¥", "–¥–Ω—è –ø–æ–¥—Ä—è–¥", "–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥"])}`;

      openInfoModal({
        svgHTML: svg,
        title: "–°–µ—Ä–∏—è –¥–Ω–µ–π",
        statusText,
        statusEarned: streak > 0,
        body: streak > 0
          ? getStreakPraise(streak)
          : "–ö–∞–∫ —Ç–æ–ª—å–∫–æ –∑–∞–ø—É—Å—Ç–∏—à—å —Ç–∞–π–º–µ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥, –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ç–≤–æ—è —Å–µ—Ä–∏—è –∏ —É–≤–∞–∂–µ–Ω–∏–µ –∑–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å."
      });
    });

    infoCloseBtn.addEventListener('click', () => {
      tactileTap();
      closeInfoModal();
    });

    infoModal.addEventListener('click', (e) => {
      if (e.target === infoModal) {
        tactileTap();
        closeInfoModal();
      }
    });

    genderMaleBtn.addEventListener('click', () => {
      tactileTap();
      setGender("male");
    });
    genderFemaleBtn.addEventListener('click', () => {
      tactileTap();
      setGender("female");
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    settingsBtn.addEventListener('click', () => {
      tactileTap();
      openSettingsModal();
    });

    settingsCloseBtn.addEventListener('click', () => {
      tactileTap();
      closeSettingsModal();
    });

    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) {
        tactileTap();
        closeSettingsModal();
      }
    });

    themeDarkBtn.addEventListener('click', () => {
      tactileTap();
      applyTheme("dark");
    });

    themeLightBtn.addEventListener('click', () => {
      tactileTap();
      applyTheme("light");
    });

    settingsGenderMale.addEventListener('click', () => {
      tactileTap();
      setGender("male");
    });

    settingsGenderFemale.addEventListener('click', () => {
      tactileTap();
      setGender("female");
    });

    settingsTourBtn.addEventListener('click', () => {
      tactileTap();
      closeSettingsModal();
      openTour();
    });

    // –û–Ω–±–æ—Ä–¥–∏–Ω–≥
    tourNextBtn.addEventListener('click', () => {
      tactileTap();
      tourIndex++;
      if (tourIndex >= tourSteps.length) {
        closeTour(true);
      } else {
        renderTourStep();
      }
    });

    tourSkipBtn.addEventListener('click', () => {
      tactileTap();
      closeTour(true);
    });

    tourModal.addEventListener('click', (e) => {
      if (e.target === tourModal) {
        tactileTap();
        closeTour(true);
      }
    });

    // –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    loadGenderFromStorage();
    loadThemeFromStorage();
    initCyclesToday();
    resetTipIndexForPhase();
    updateDisplay();
    initStreak();
    updateWaterGradientForTheme();

    // –µ—Å–ª–∏ –ø–æ–ª–∞ –µ—â—ë –Ω–µ—Ç ‚Äî —Å–ø—Ä–æ—Å–∏–º, –∏–Ω–∞—á–µ –º–æ–∂–µ–º —Å—Ä–∞–∑—É –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å —Ç—É—Ä
    showGenderModalIfNeeded();
    if (userGender) {
      maybeStartTourAuto();
    }
  </script>
</body>
</html>
